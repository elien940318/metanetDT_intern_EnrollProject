<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="com.oopsw.member.dao.RegisterDAO"> 
	
	<select id="getNameList" resultType="com.oopsw.member.dto.StudentDTO"> 
		 SELECT s.subject_no,subj_name,subj_score,dep.dept_name,subj_professor
		 FROM subjects s, departmentes dep
		 WHERE dep.department_no = s.department_no <include refid="search"></include>
	</select>
	<select id="getPlanDetail" resultType="com.oopsw.member.dto.StudentDTO"> 
		 SELECT s.subject_no,subj_name,subj_score,dep.dept_name,subj_professor,lect_date,lect_start,lect_end,lect_room,outline,proceed,note,evaluation,progress_plan
		 FROM subjects s, departmentes dep
		 WHERE dep.department_no = s.department_no AND s.subject_no =#{subjectNo}
	</select>
	
	<select id="getSubjectList" resultType="com.oopsw.member.dto.RegisterDTO"> 
		 SELECT subject_no as subjectNo, subj_group as subjGroup, subj_name as subjName, subj_score as subjScore, lect_room as lectRoom
		    , subj_professor as subjProfessor, lect_date as lectDate, lect_start as lectStart, lect_end as lectEnd, d.dept_name as deptName
		    , ( SELECT ( SUM(eval_how)/COUNT(*) + SUM(eval_planning)/COUNT(*) 
		               + SUM(eval_goal)/COUNT(*) + SUM(eval_consider)/COUNT(*) 
		               + SUM(eval_test)/COUNT(*) ) / 5
		        FROM registers r, subjects s1
		        WHERE r.subject_no = s1.subject_no
		          AND s1.subject_no = s.subject_no
		          AND s1.subj_professor = s.subj_professor
		          AND r.reg_year=#{register.regYear}
		          AND r.reg_semester=#{register.regSemester}
		      )  as lectureScore
		FROM subjects s, departmentes d
		WHERE s.department_no = d.department_no AND subj_semester=#{register.regSemester}
		ORDER BY lectureScore desc
	</select>
	
	<select id ="getRegisterList" resultType="com.oopsw.member.dto.RegisterDTO">
		 SELECT r.subject_no as subjectNo, subj_group as subjGroup , subj_name as subjName, subj_score as subjScore
		 		, subj_professor as subjProfessor, lect_date as lectDate, lect_start as lectStart, lect_end as lectEnd
		 		, d.dept_name as deptName, lect_room as lectRoom
		 FROM registers r, subjects s, departmentes d
		 WHERE r.subject_no = s.subject_no
		 AND s.department_no = d.department_no
		 AND r.reg_year=#{register.regYear} AND r.reg_semester=#{register.regSemester}
		 AND student_id = #{register.studentId}
	</select>
	
	<insert id="setRegister" parameterType="com.oopsw.member.dto.RegisterDTO">
		insert into registers(register_no, reg_year, reg_semester, student_id, subject_no)
 		values(registers_seq.NEXTVAL, #{register.regYear}, #{register.regSemester}, #{register.studentId}, #{register.subjectNo})
	</insert>
	
	<delete id="deleteRegister" parameterType="com.oopsw.member.dto.RegisterDTO">
		delete from registers
		where reg_year=#{register.regYear} AND reg_semester=#{register.regSemester} AND student_id=#{register.studentId} AND subject_no=#{register.subjectNo}
	</delete>

	<sql id="search">
		<if test="searchType != null">
			<if test="searchType == 's'.toString()">AND s.subj_name LIKE '%'||#{search}||'%'</if>
			<if test="searchType == 'p'.toString()">AND s.subj_professor LIKE '%'||#{search}||'%'</if>
			<if test="searchType == 'n'.toString()">AND s.subject_no LIKE '%'||#{search}||'%'</if>
		</if>
	</sql>

</mapper>